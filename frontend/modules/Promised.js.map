{"version":3,"file":"Promised.js","sources":["../../../../modules/projects/core.ts/src/utils/Promised.ts"],"sourcesContent":["import { unwrap, isPrimitive, tryParseByHint, fixFx } from \"./Primitive\";\n\n//\nconst resolvedMap = new WeakMap(), handledMap = new WeakMap();\nconst actWith = (promiseOrPlain, cb)=>{\n    if (promiseOrPlain instanceof Promise || typeof promiseOrPlain?.then == \"function\") {\n        if (resolvedMap?.has?.(promiseOrPlain)) { return cb(resolvedMap?.get?.(promiseOrPlain)); }\n        // @ts-ignore\n        return Promise.try?.(async ()=>{\n            const item = await promiseOrPlain;\n            resolvedMap?.set?.(promiseOrPlain, item);\n            return item;\n        })?.then?.(cb);\n    }\n    return cb(promiseOrPlain);\n}\n\n//\nclass PromiseHandler {\n    #resolve?: ((...args: any[])=>void)|null;\n    #reject?: ((...args: any[])=>void)|null;\n\n    //\n    constructor(resolve?: ((...args: any[])=>void)|null, reject?: ((...args: any[])=>void)|null) {\n        this.#resolve = resolve;\n        this.#reject = reject;\n    }\n\n    //\n    defineProperty(target, prop, descriptor) {\n        if (unwrap(target) instanceof Promise) return Reflect.defineProperty(target, prop, descriptor);\n        return actWith(unwrap(target), (obj)=>Reflect.defineProperty(obj, prop, descriptor));\n    }\n\n    //\n    deleteProperty(target, prop) {\n        if (unwrap(target) instanceof Promise) return Reflect.deleteProperty(target, prop);\n        return actWith(unwrap(target), (obj)=>Reflect.deleteProperty(obj, prop));\n    }\n\n    //\n    getPrototypeOf(target) {\n        if (unwrap(target) instanceof Promise) return Reflect.getPrototypeOf(target);\n        return actWith(unwrap(target), (obj)=>Reflect.getPrototypeOf(obj));\n    }\n\n    //\n    setPrototypeOf(target, proto) {\n        if (unwrap(target) instanceof Promise) return Reflect.setPrototypeOf(target, proto);\n        return actWith(unwrap(target), (obj)=>Reflect.setPrototypeOf(obj, proto));\n    }\n\n    //\n    isExtensible(target) {\n        if (unwrap(target) instanceof Promise) return Reflect.isExtensible(target);\n        return actWith(unwrap(target), (obj)=>Reflect.isExtensible(obj));\n    }\n\n    //\n    preventExtensions(target) {\n        if (unwrap(target) instanceof Promise) return Reflect.ownKeys(target);\n        return actWith(unwrap(target), (obj)=>Reflect.preventExtensions(obj));\n    }\n\n    //\n    ownKeys(target) {\n        const uwp = unwrap(target);\n        if (uwp instanceof Promise) return Object.keys(uwp);\n        const keys = actWith(uwp, (obj)=>{ return (typeof obj == \"object\" || typeof obj == \"function\") && obj != null ? Object.keys(obj) : [] });\n        return keys ?? [];\n    }\n\n    //\n    getOwnPropertyDescriptor(target, prop) {\n        if (unwrap(target) instanceof Promise) return Reflect.getOwnPropertyDescriptor(target, prop);\n        return actWith(unwrap(target), (obj)=>Reflect.getOwnPropertyDescriptor(obj, prop));\n    }\n\n    //\n    construct(target, args, newTarget) {\n        return actWith(unwrap(target), (ct)=>Reflect.construct(ct, args, newTarget));\n    }\n\n    //\n    has(target, prop) {\n        if (unwrap(target) instanceof Promise) return Reflect.has(target, prop);\n        return actWith(unwrap(target), (obj)=>Reflect.has(obj, prop));\n    }\n\n    //\n    get(target, prop, receiver) {\n        target = unwrap(target);\n\n        //\n        if (prop == 'promise') { return target; } // @ts-ignore\n        if (prop == 'resolve' && this.#resolve) { return (...args)=>{ const result = this.#resolve?.(...args); this.#resolve = null; return result; }; } // @ts-ignore\n        if (prop == 'reject'  && this.#reject ) { return (...args)=>{ const result = this.#reject?.(...args);  this.#reject  = null; return result; }; } // @ts-ignore\n        if (prop == 'then' || prop == 'catch' || prop == 'finally') {\n            if (target instanceof Promise) {\n                return target?.[prop]?.bind?.(target);\n            } else {\n                const $tmp = Promise.try(()=>target);\n                return $tmp?.[prop]?.bind?.($tmp);\n            }\n        }\n\n        // @ts-ignore\n        const result = Promised(actWith(target, async (obj)=>{\n            if (unwrap(obj) instanceof Promise) return Reflect.get(obj, prop, receiver);\n            if (isPrimitive(obj)) { return (prop == Symbol.toPrimitive || prop == Symbol.toStringTag) ? obj : undefined; }\n            let value: any = undefined;\n            try { value = Reflect.get(obj, prop, receiver); } catch (e) { value = target?.[prop]; }\n            if (typeof value == 'function') { return value?.bind?.(obj); }\n            return value;\n        }));\n\n        //\n        if (prop == Symbol.toStringTag) {\n            if (isPrimitive(result)) { return String(result ?? \"\") || \"\"; };\n            return result?.[Symbol.toStringTag]?.() || String(result ?? \"\") || \"\";\n        }\n\n        //\n        if (prop == Symbol.toPrimitive) { return (hint?)=>{\n            if (isPrimitive(result)) { return tryParseByHint(result, hint); };\n            return null;//tryParseByHint(result?.[Symbol.toPrimitive]?.());\n        }}\n\n        //\n        return result;\n    }\n\n    //\n    set(target, prop, value) {\n        return actWith(unwrap(target), (obj)=>Reflect.set(obj, prop, value));\n    }\n\n    //\n    apply(target, thisArg, args) { // @ts-ignore\n        if (this.#resolve) { const result = this.#resolve?.(...args); this.#resolve = null; return result; }\n        return actWith(unwrap(target, this.#resolve), (obj) => {\n            if (typeof obj == \"function\") {\n                if (unwrap(obj) instanceof Promise) return Reflect.apply(obj, thisArg, args);\n                return Reflect.apply(obj, thisArg, args);\n            }\n        });\n    }\n}\n\n/**\n * Type alias for Promise-like values (Promise or any value).\n * @template T - The resolved value type\n */\nexport type PromiseLike<T=any> = Promise<T>|any;\n\n/**\n * Wrap a promise or value in a Proxy that allows synchronous property access.\n * For resolved promises, this enables accessing properties as if the promise was already resolved.\n * @template T - The resolved value type\n * @param promise - The promise or value to wrap\n * @param resolve - Optional resolve callback\n * @param reject - Optional reject callback\n * @returns A proxy that allows synchronous-style access to promise values\n */\nexport function Promised<T=any>(promise: PromiseLike<T>, resolve?: ((...args: any[])=>void)|null, reject?: ((...args: any[])=>void)|null) {\n    if (!(promise instanceof Promise || typeof promise?.then == \"function\")) { return promise; }\n    if (resolvedMap?.has?.(promise)) { return resolvedMap?.get?.(promise); };\n    if (!handledMap?.has?.(promise)) { promise?.then?.((item)=>resolvedMap?.set?.(promise, item)); } // @ts-ignore\n    return handledMap?.getOrInsertComputed?.(promise, ()=>new Proxy<PromiseLike<T>>(fixFx(promise), new PromiseHandler(resolve, reject)));\n}\n\n//if ([\"then\", \"catch\", \"finally\"].includes(prop as string)) { return (typeof withUpdate?.[prop] == \"function\" ? withUpdate?.[prop]?.bind?.(withUpdate) : withUpdate?.[prop]); }\n"],"names":["result"],"mappings":"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"}