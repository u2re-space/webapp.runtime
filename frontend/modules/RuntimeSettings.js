import{a as e}from"./vendor/webdav.js";import"./fest/dom.js";import"./fest/core.js";import"./fest/object.js";import{w as t,U as n,k as a}from"./fest/lure.js";import{J as r}from"./vendor/jsox.js";const o={core:{mode:"native",endpointUrl:"http://localhost:6065",userId:"",userKey:"",encrypt:!1,preferBackendSync:!0,ntpEnabled:!1,ops:{allowUnencrypted:!1,httpTargets:[],wsTargets:[],syncTargets:[]}},ai:{apiKey:"",baseUrl:"",model:"gpt-5.2",customModel:"",mcp:[],shareTargetMode:"recognize",customInstructions:[],activeInstructionId:"",responseLanguage:"auto",translateResults:!1,generateSvgGraphics:!1,requestTimeout:{low:60,medium:300,high:900},maxRetries:2},webdav:{url:"http://localhost:6065",username:"",password:"",token:""},timeline:{source:""},appearance:{theme:"auto",color:""},speech:{language:"undefined"!=typeof navigator?navigator.language:"en-US"},grid:{columns:4,rows:8,shape:"square"}},s=(e,t=!0)=>{let n=String(e||"").trim();return t&&(n=n.toLowerCase()),n=n.replace(/\s+/g,"-"),n=n.replace(/[^a-z0-9_.\-+#&]/g,"-"),n=n.replace(/-+/g,"-"),n},c=e=>String(e||"").split("/").filter(Boolean),i=["id","_id","key","slug","name"],l=e=>"[object Object]"===Object.prototype.toString.call(e);function u(e,t,n){if(Array.isArray(e)&&Array.isArray(t))switch(n.arrayStrategy){case"replace":return t.slice();case"concat":return e.concat(t);default:return function(e,t){const n=Array.isArray(t.arrayKey)?t.arrayKey:t.arrayKey?[t.arrayKey]:i,a=[],r=/* @__PURE__ */new Set,o=/* @__PURE__ */new Map,s=/* @__PURE__ */new Set;for(const c of e)if(null!=c)if(l(c)){let e;for(const t of n)if(t in c&&null!=c[t]){e=String(c[t]);break}if(null!=e)o.has(e)||(o.set(e,c),a.push(c));else{const e=d(c);s.has(e)||(s.add(e),a.push(c))}}else if(Array.isArray(c)){const e=d(c);s.has(e)||(s.add(e),a.push(c))}else r.has(c)||(r.add(c),a.push(c));return a}(e.concat(t),{arrayKey:n.arrayKey})}if(l(e)&&l(t)){const a={...e};for(const r of Object.keys(t))a[r]=r in e?u(e[r],t[r],n):t[r];return a}return t}function d(e){if(!l(e))return JSON.stringify(e);const t=Object.keys(e).sort(),n={};for(const a of t)n[a]=e[a];return JSON.stringify(n)}async function p(e){return await e.text()}const w=async(e,a,o,i={})=>{const{forceExt:l,ensureJson:d,toLower:w=!0,sanitize:y=!0,mergeJson:m,arrayStrategy:f="union",arrayKey:g,jsonSpace:h=2}=i;let b=String(a||"").trim();const v=b.endsWith("/"),S=!v&&c(b).length>0&&b.includes(".");let I=v?b:S?b.split("/").slice(0,-1).join("/"):b,j=S?b.split("/").pop()||"":o?.name||"";I=I||"/",j=j||Date.now()+"";const B=j.lastIndexOf(".");let x=B>0?j.slice(0,B):j,k=l||(d?"json":B>0?j.slice(B+1):((e="")=>e?e.includes("json")?"json":e.includes("markdown")?"md":e.includes("plain")?"txt":"image/jpeg"===e||"image/jpg"===e?"jpg":"image/png"===e?"png":e.startsWith("image/")?e.split("/").pop()||"":e.includes("html")?"html":"":"")(o?.type||""))||"";y&&(I=((e,t=!0)=>(t?"/":"")+e.filter(Boolean).join("/"))(c(I).map(e=>s(e))),x=s(x,w));const D=k?`${x}.${k}`:x,E=((C=I).endsWith("/")?C:C+"/")+D;var C;if(!1!==m&&(d||"json"===k.toLowerCase()||"application/json"===o?.type))try{let a;if(o instanceof File||o instanceof Blob){const e=await p(o);a=e?.trim()?r.parse(e):{}}else a=o;const s=await(async function(e,t){try{const a=await(n(e,t)?.catch?.(console.warn.bind(console)));if(!a)return null;const o=await p(a);return o?.trim()?r.parse(o):null}catch{return null}}(e,E)?.catch?.(console.warn.bind(console)));let c=null!=s?u(s,a,{arrayStrategy:f,arrayKey:g}):a;const i=JSON.stringify(c,void 0,h),l=new File([i],D,{type:"application/json"}),d=await(t(e,E,l)?.catch?.(console.warn.bind(console)));return"undefined"!=typeof document&&document?.dispatchEvent?.(new CustomEvent("rs-fs-changed",{detail:d,bubbles:!0,composed:!0,cancelable:!0})),d}catch(O){console.warn("writeFileSmart JSON merge failed, falling back to raw write:",O)}let A;if(o instanceof File)if(o.name===D)A=o;else{const e=o.type||(k?`application/${k}`:"application/octet-stream"),t=await o.arrayBuffer();A=new File([t],D,{type:e})}else{const e=o.type||(k?`application/${k}`:"application/octet-stream"),t=o;A=new File([await t.arrayBuffer()],D,{type:e})}const L=await(t(e,E,A)?.catch?.(console.warn.bind(console)));return"undefined"!=typeof document&&document?.dispatchEvent?.(new CustomEvent("rs-fs-changed",{detail:L,bubbles:!0,composed:!0,cancelable:!0})),L},y="rs-settings",m=(e,t)=>(e=>e.split("."))(t).reduce((e,t)=>null==e?e:e[t],e),f=e=>e.replace(/[^a-z0-9]+/gi,"-").replace(/^-+|-+$/g,"").toLowerCase(),g="settings",h=()=>{try{return!("undefined"==typeof chrome||!chrome?.runtime||"undefined"==typeof window||!window.location?.protocol?.startsWith("http"))}catch{return!1}},b=()=>"undefined"!=typeof chrome&&chrome?.storage?.local;async function v(){if("undefined"==typeof indexedDB)throw new Error("IndexedDB not available");if(h())throw new Error("IndexedDB not accessible in content script context");return new Promise((e,t)=>{try{const n=indexedDB.open("req-store",1);n.onupgradeneeded=()=>n.result.createObjectStore(g,{keyPath:"key"}),n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)}catch(n){t(n)}})}const S=async()=>{try{const e=await(async(e=y)=>{try{if(b())return console.log("[Settings] Using chrome.storage.local for get"),new Promise(t=>{try{chrome.storage.local.get([e],n=>{chrome.runtime.lastError?(console.warn("[Settings] chrome.storage.local.get error:",chrome.runtime.lastError),t(null)):(console.log("[Settings] chrome.storage.local.get success, has data:",!!n[e]),t(n[e]))})}catch(n){console.warn("[Settings] chrome.storage access failed:",n),t(null)}});if("undefined"==typeof indexedDB)return console.warn("[Settings] IndexedDB not available"),null;console.log("[Settings] Using IndexedDB for get");const t=await v();return new Promise((n,a)=>{const r=t.transaction(g,"readonly").objectStore(g).get(e);r.onsuccess=()=>{console.log("[Settings] IndexedDB get success, has data:",!!r.result?.value),n(r.result?.value),t.close()},r.onerror=()=>{console.warn("[Settings] IndexedDB get error:",r.error),a(r.error),t.close()}})}catch(t){return console.warn("[Settings] Settings storage access failed:",t),null}})(),t="string"==typeof e?r.parse(e):e;if(console.log("[Settings] loadSettings - raw type:",typeof e,"stored type:",typeof t),t&&"object"==typeof t){const e={core:{...o.core,...t?.core},ai:{...o.ai,...t?.ai,mcp:t?.ai?.mcp||[],customInstructions:t?.ai?.customInstructions||[],activeInstructionId:t?.ai?.activeInstructionId||""},webdav:{...o.webdav,...t?.webdav},timeline:{...o.timeline,...t?.timeline},appearance:{...o.appearance,...t?.appearance},speech:{...o.speech,...t?.speech},grid:{...o.grid,...t?.grid}};return console.log("[Settings] loadSettings result:",{hasApiKey:!!e.ai?.apiKey,instructionCount:e.ai?.customInstructions?.length||0,activeInstructionId:e.ai?.activeInstructionId||"(none)"}),e}console.log("[Settings] loadSettings - no stored data, returning defaults")}catch(e){console.warn("[Settings] loadSettings error:",e)}return r.parse(r.stringify(o))},I=async e=>{const t=await S(),n={core:{...o.core||{},...t.core||{},...e.core||{}},ai:{...o.ai||{},...t.ai||{},...e.ai||{},mcp:void 0!==e.ai?.mcp?e.ai.mcp:void 0!==t.ai?.mcp?t.ai.mcp:[],customInstructions:void 0!==e.ai?.customInstructions?e.ai.customInstructions:void 0!==t.ai?.customInstructions?t.ai.customInstructions:[],activeInstructionId:Object.prototype.hasOwnProperty.call(e.ai||{},"activeInstructionId")?e.ai?.activeInstructionId??"":void 0!==t.ai?.activeInstructionId?t.ai.activeInstructionId:""},webdav:{...o.webdav||{},...t.webdav||{},...e.webdav||{}},timeline:{...o.timeline||{},...t.timeline||{},...e.timeline||{}},appearance:{...o.appearance||{},...t.appearance||{},...e.appearance||{}},speech:{...o.speech||{},...t.speech||{},...e.speech||{}},grid:{...o.grid||{},...t.grid||{},...e.grid||{}}};return await(async(e,t=y)=>{try{if(b())return new Promise((n,a)=>{try{chrome.storage.local.set({[t]:e},()=>{chrome.runtime.lastError?a(chrome.runtime.lastError):n()})}catch(r){console.warn("chrome.storage write failed:",r),a(r)}});if("undefined"==typeof indexedDB)return void console.warn("IndexedDB not available");const n=await v();return new Promise((a,r)=>{const o=n.transaction(g,"readwrite");o.objectStore(g).put({key:t,value:e}),o.oncomplete=()=>{a(void 0),n.close()},o.onerror=()=>{r(o.error),n.close()}})}catch(n){console.warn("Settings storage write failed:",n)}})(n),C(n)?.catch?.(console.warn.bind(console)),n},j=(e,t,n=!1)=>{const a=(e||"/").replace(/\/+$/g,"")||"/",r=(t||"").replace(/^\/+/g,"");let o="/"===a?`/${r}`:`${a}/${r}`;return n&&(o=o.replace(/\/?$/g,"/")),o.replace(/\/{2,}/g,"/")},B=e=>{const t=new Date(e).getTime();return Number.isFinite(t)?t:0},x=async(e,t="/",r={},o=null)=>{const s=await(e?.getDirectoryContents?.(t||"/")?.catch?.(e=>(console.warn(e),[])));if(r.pruneLocal&&s?.length>0)try{const e=await(a(o,t)?.catch?.(()=>null));if(e?.entries){const t=await Array.fromAsync(e.entries()),n=new Set(s?.map?.(e=>e?.basename).filter(Boolean));await Promise.all(t.filter(([e])=>!n.has(e)).map(([t])=>e.removeEntry(t,{recursive:!0})?.catch?.(console.warn.bind(console))))}}catch(c){console.warn(c)}return Promise.all(s.map(async t=>{const a="directory"===t?.type,s=a?j(t.filename,"",!0):t.filename;if(a)return x(e,s,r,o);if("file"===t?.type){const a=await n(o,s).catch(()=>null),r=B(a?.lastModified);if(B(t?.lastmod)>r){const n=await e.getFileContents(s).catch(e=>(console.warn(e),null));if(!n||0===n.byteLength)return;return w(o,s,new File([n],t.basename,{type:t?.mime||"application/octet-stream"}))}}}))},k=async(e,t=null,n="/",r={})=>{const o=t??await(a(null,n,{create:!0})?.catch?.(console.warn.bind(console))),s=await Array.fromAsync(o?.entries?.()??[]);if("/"!=n&&r.pruneRemote&&s?.length>=0){const t=await e.getDirectoryContents(n||"/").catch(e=>(console.warn(e),[])),a=new Set(s.map(([e])=>e.toLowerCase())),r=[...t.filter(e=>{const t=(e?.basename||"").toLowerCase();return t&&!a.has(t)}).filter(e=>"directory"!==e.type)];for(const o of r){const t=o.filename||j(n,o.basename,"directory"===o.type);try{await e.deleteFile(t)}catch(c){console.warn("delete failed:",t,c)}}}await Promise.all(s.map(async([t,a])=>{const o=(s=a,"directory"===s?.kind);var s;const c=j(n,t,o);if(o){const o=j(n,t,!1);return await e.exists(o).catch(e=>!1)||await e.createDirectory(o,{recursive:!0}).catch(console.warn),k(e,a,c,r)}const i=a,l=await i.getFile();if(!l||0===l.size)return;const u=j(n,t,!1),d=await e.stat(u).catch(()=>null),p=B(d?.lastmod),w=B(l.lastModified);(!d||w>p)&&await e.putFileContents(u,await l.arrayBuffer(),{overwrite:!0}).catch(e=>null)}))},D=(t,n={})=>{const a=e((e=>{const t=new URL(e);return t.protocol+t.hostname+":"+t.port})(t),n);return{status:E?.sync?.getDAVCompliance?.()?.catch?.(console.warn.bind(console))??null,client:a,upload(e=!1){if(null!=this.status)return k(a,null,"/",{pruneRemote:e})?.catch?.(e=>(console.warn(e),[]))},download(e=!1){if(null!=this.status)return x(a,"/",{pruneLocal:e})?.catch?.(e=>(console.warn(e),[]))}}},E={sync:null};h()||(async()=>{try{const e=await S();if("endpoint"===e?.core?.mode&&e?.core?.preferBackendSync)return;if(!e?.webdav?.url)return;const t=D(e.webdav.url,{withCredentials:!0,username:e.webdav.username,password:e.webdav.password,token:e.webdav.token});E.sync=t??E.sync,await(E?.sync?.upload?.(!0)),await(E?.sync?.download?.(!0))}catch(e){}})();const C=async e=>{e||=await S(),"endpoint"===e?.core?.mode&&e?.core?.preferBackendSync?E.sync=null:e?.webdav?.url&&(E.sync=D(e.webdav.url,{withCredentials:!0,username:e.webdav.username,password:e.webdav.password,token:e.webdav.token})??E.sync,await(E?.sync?.upload?.()),await(E?.sync?.download?.(!0)))};if(!h()){try{"undefined"!=typeof window&&"function"==typeof addEventListener&&(addEventListener("pagehide",()=>{E?.sync?.upload?.()?.catch?.(()=>{})}),addEventListener("beforeunload",()=>{E?.sync?.upload?.()?.catch?.(()=>{})}))}catch{}(async()=>{try{for(;;)await(E?.sync?.upload?.()?.catch?.(()=>{})),await new Promise(e=>setTimeout(e,3e3))}catch{}})()}let A=S;const L=async()=>{try{return await A()||o}catch{return o}},O=/*#__PURE__*/Object.freeze(/*#__PURE__*/Object.defineProperty({__proto__:null,getRuntimeSettings:L},Symbol.toStringTag,{value:"Module"}));export{o as D,O as R,f as a,L as b,E as c,m as g,S as l,I as s,w};