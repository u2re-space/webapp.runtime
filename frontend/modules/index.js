import"./fest/dom.js";import"./fest/core.js";import"./fest/object.js";import{H as e}from"./fest/lure.js";class t{static instance;assetVersions=/* @__PURE__ */new Map;updateCheckInterval=null;isChecking=!1;static getInstance(){return t.instance||(t.instance=new t),t.instance}async checkAssetUpdate(e,t){try{const t=await fetch(e,{method:"HEAD",cache:"no-cache",headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});if(!t.ok)return!1;const o=`${t.headers.get("etag")||""}-${t.headers.get("last-modified")||""}-${t.headers.get("content-length")||""}`,n=this.assetVersions.get(e);return n&&n!==o?(console.log(`[AssetUpdate] Asset updated: ${e}`),this.assetVersions.set(e,o),!0):(this.assetVersions.set(e,o),!1)}catch(o){return console.warn(`[AssetUpdate] Failed to check asset: ${e}`,o),!1}}forceRefreshAsset(e){const t=e.includes("?")?"&":"?";return`${e}${t}_cache=${Date.now()}`}async checkAllAssets(){if(this.isChecking)return[];this.isChecking=!0;const e=["./choice.js","./assets/crossword.css","./sw.js","./favicon.svg","./favicon.png"],t=[];try{const o=e.map(async e=>{await this.checkAssetUpdate(e)&&t.push(e)});await Promise.all(o)}finally{this.isChecking=!1}return t}startPeriodicChecks(e=3e5){this.updateCheckInterval&&clearInterval(this.updateCheckInterval),this.updateCheckInterval=window.setInterval(async()=>{const e=await this.checkAllAssets();e.length>0&&(console.log("[AssetUpdate] Updated assets detected:",e),window.dispatchEvent(new CustomEvent("assets-updated",{detail:{updatedAssets:e}})))},e)}stopPeriodicChecks(){this.updateCheckInterval&&(clearInterval(this.updateCheckInterval),this.updateCheckInterval=null)}}function o(){const e=document.querySelector(".app-reload-notification");e&&e.remove();const t=document.createElement("div");t.className="app-reload-notification",Object.assign(t.style,{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",background:"rgba(0, 0, 0, 0.9)",color:"white",padding:"24px",borderRadius:"12px",zIndex:"10002",fontFamily:"system-ui, -apple-system, sans-serif",textAlign:"center",boxShadow:"0 8px 32px rgba(0,0,0,0.4)",backdropFilter:"blur(10px)",border:"1px solid rgba(255,255,255,0.1)"}),t.innerHTML='\n        <div style="font-size: 1.5rem; margin-bottom: 8px;">üîÑ</div>\n        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">Update Available</div>\n        <div style="opacity: 0.8; margin-bottom: 16px;">CrossWord has been updated and will reload shortly.</div>\n        <div style="font-size: 0.9rem; opacity: 0.6;">Reloading in 3 seconds...</div>\n    ',document.body.appendChild(t);let o=3;const n=setInterval(()=>{o--;const e=t.querySelector("div:last-child");e&&(e.textContent=`Reloading in ${o} second${1!==o?"s":""}...`),o<=0&&(clearInterval(n),window.location.reload())},1e3);t.addEventListener("click",()=>{clearInterval(n),window.location.reload()})}class n{registration=null;updateToast=null;async register(){if(!("serviceWorker"in navigator)||(()=>{try{return"undefined"!=typeof chrome&&Boolean(chrome?.runtime?.id)&&"chrome-extension:"===window.location.protocol}catch{return!1}})())return null;try{const e=new URL("../sw.js",import.meta.url).href;return console.log("[SW] Registering service worker:",e),this.registration=await navigator.serviceWorker.register(e,{scope:"/",type:"module",updateViaCache:"none"}),console.log("[SW] Service worker registered successfully"),this.setupUpdateListeners(),this.startPeriodicUpdates(),this.registration}catch(e){return console.error("[SW] Registration failed:",e),null}}setupUpdateListeners(){this.registration&&(this.registration.addEventListener("updatefound",()=>{const e=this.registration?.installing;e&&(console.log("[SW] New service worker found, installing..."),e.addEventListener("statechange",()=>{"installed"===e.state?navigator.serviceWorker.controller?(console.log("[SW] New service worker installed, ready to activate"),this.showUpdateNotification()):console.log("[SW] Service worker installed for offline use"):"activated"===e.state&&(console.log("[SW] New service worker activated"),window.dispatchEvent(new CustomEvent("sw-activated",{detail:{registration:this.registration}})))}))}),navigator.serviceWorker.addEventListener("controllerchange",()=>{console.log("[SW] Controller changed - new service worker active"),window.dispatchEvent(new CustomEvent("sw-controller-changed"))}),navigator.serviceWorker.addEventListener("message",e=>{const{type:t,data:n}=e.data||{};switch(t){case"sw-update-ready":console.log("[SW] Service worker reports update ready"),this.showUpdateNotification();break;case"asset-updated":console.log("[PWA] Service worker detected asset update:",n),(n.url.includes("choice.js")||n.url.includes("sw.js"))&&o();break;case"sw-activated":console.log("[PWA] Service worker activated");break;case"cache-status":console.log("[PWA] Cache status:",n);break;default:console.log("[PWA] Unknown SW message:",t,n)}}))}startPeriodicUpdates(){setInterval(()=>{this.registration?.update().catch(console.warn)},18e5)}showUpdateNotification(){this.hideUpdateNotification(),this.updateToast=document.createElement("div"),Object.assign(this.updateToast.style,{position:"fixed",top:"20px",right:"20px",background:"#007acc",color:"white",padding:"16px 20px",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",zIndex:"10000",fontFamily:"system-ui, sans-serif",fontSize:"14px",cursor:"pointer",maxWidth:"300px",transition:"all 0.3s ease"}),this.updateToast.innerHTML='\n            <div style="font-weight: 600; margin-bottom: 4px;">Update Available</div>\n            <div style="opacity: 0.9; margin-bottom: 12px;">A new version of CrossWord is ready</div>\n            <div style="display: flex; gap: 8px;">\n                <button id="update-now" style="\n                    background: white;\n                    color: #007acc;\n                    border: none;\n                    padding: 6px 12px;\n                    border-radius: 4px;\n                    font-size: 12px;\n                    font-weight: 600;\n                    cursor: pointer;\n                ">Update Now</button>\n                <button id="update-later" style="\n                    background: transparent;\n                    color: white;\n                    border: 1px solid rgba(255,255,255,0.3);\n                    padding: 6px 12px;\n                    border-radius: 4px;\n                    font-size: 12px;\n                    cursor: pointer;\n                ">Later</button>\n            </div>\n        ';const e=this.updateToast.querySelector("#update-now"),t=this.updateToast.querySelector("#update-later");e?.addEventListener("click",()=>{this.applyUpdate()}),t?.addEventListener("click",()=>{this.hideUpdateNotification()}),setTimeout(()=>{this.hideUpdateNotification()},3e4),document.body.appendChild(this.updateToast),window.dispatchEvent(new CustomEvent("sw-update-notification-shown"))}hideUpdateNotification(){this.updateToast&&(this.updateToast.style.opacity="0",setTimeout(()=>{this.updateToast?.remove(),this.updateToast=null},300))}async applyUpdate(){console.log("[SW] Applying service worker update..."),this.hideUpdateNotification(),this.registration?.waiting&&this.registration.waiting.postMessage({type:"SKIP_WAITING"}),window.location.reload()}async checkForUpdates(){await(this.registration?.update())}}const a=async()=>{console.log("[PWA] Manual update check requested");try{if("serviceWorker"in navigator&&navigator.serviceWorker.controller){const e=await navigator.serviceWorker.getRegistration();e&&(console.log("[PWA] Checking service worker for updates..."),await e.update(),e.active&&e.active.postMessage({type:"CHECK_FOR_UPDATES"}))}const e=t.getInstance(),o=await e.checkAllAssets();o.length>0?(console.log("[PWA] Asset updates found:",o),window.dispatchEvent(new CustomEvent("assets-updated",{detail:{updatedAssets:o}}))):(console.log("[PWA] No updates found"),window.dispatchEvent(new CustomEvent("app-up-to-date")))}catch(e){throw console.error("[PWA] Manual update check failed:",e),e}},s=async()=>{console.log("[PWA] Force refreshing all cached assets");try{const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e))),console.log("[PWA] All caches cleared"),window.location.reload()}catch(e){throw console.error("[PWA] Failed to force refresh assets:",e),e}},r=async e=>{console.log("[App] Loading sub-app:",e);try{let t;"faint"===e?(console.log("[App] Importing faint app..."),t=await import("./Views.js"),console.log("[App] Faint app imported successfully")):"basic"==e?(console.log("[App] Importing basic app..."),t=await import("./index2.js"),console.log("[App] Basic app imported successfully")):"print"==e?(console.log("[App] Importing print app..."),t=await import("./index3.js"),console.log("[App] Print app imported successfully")):e&&"/"!=e||(console.log("[App] Importing basic app..."),t=await Promise.resolve().then(()=>c),console.log("[App] Basic app imported successfully"));const o=t?.default;if("function"!=typeof o)throw new Error("Invalid app module: expected default export to be a function, got "+typeof o);return{mount:async t=>{console.log("[App] Mounting",e,"app..."),await o(t),console.log("[App] App mounted successfully")}}}catch(t){throw console.error("[App] Failed to load sub-app:",e,t),t}},i=t=>{const o=e`<header class="choice-header">Boot menu</header>`,n=e`<div class="choice-reasons">Currently, I'm not able to actively support the complex <b>Faint</b> project. The <b>Basic</b> version is the default.</div>`,a=e`<div class="choice-countdown">Auto-start in <b>${t.seconds}</b>s‚Ä¶</div>`,s=e`<div class="choice-hint">Use <b>‚Üë</b>/<b>‚Üì</b> to select, <b>Enter</b> to boot.</div>`,r=e`<label class="choice-remember">
    <input type="checkbox" />
    <span>Remember my choice</span>
  </label>`,i=r.querySelector("input");i&&(i.checked=Boolean(t.initialRemember));const c=e`<button class="basic big recommended" type="button">Basic</button>`,l=e`<button class="unstable small faint" type="button">Faint OS (unstable)</button>`,d=e=>{const o=Boolean(i?.checked);if(t.tryRoutedPath&&(e=>{if((location.pathname||"").replace(/^\//,"").trim().toLowerCase()===e.toLowerCase())return!1;try{const t=`/${e.toLowerCase()}`;return console.log(`[BootMenu] Trying to navigate to routed path: ${t}`),window.history.pushState({},"",t),window.dispatchEvent(new CustomEvent("route-changed",{detail:{path:e.toLowerCase(),source:"boot-menu"}})),!0}catch(t){return console.warn(`[BootMenu] Failed to navigate to routed path for ${e}:`,t),!1}})(e)){if(o)try{localStorage.setItem("rs-frontend-choice",e),localStorage.setItem("rs-frontend-choice-remember","1")}catch{}}else t.onChoose(e,o)};c.addEventListener("click",()=>d("basic")),l.addEventListener("click",()=>d("faint"));const p=e`<div class="choice container"></div>`,u=e`<div class="choice-menu" role="menu"></div>`;u.append(c,l);const g=[c,l];let h=0;const m=e=>{const t=g.length;t&&(h=(e%t+t)%t,g[h]?.focus?.())};return p.addEventListener("keydown",e=>{if("ArrowDown"===e.key)return e.preventDefault(),void m(h+1);if("ArrowUp"===e.key)return e.preventDefault(),void m(h-1);if("Enter"===e.key){const e=document.activeElement,t=e?.closest?.("button");t?.click?.()}}),p.append(o,a,s,u,r,n),queueMicrotask(()=>m(0)),{container:p,countdownEl:a}},c=/*#__PURE__*/Object.freeze(/*#__PURE__*/Object.defineProperty({__proto__:null,ChoiceScreen:i,default:e=>{e.append(i({seconds:10,defaultChoice:"basic",onChoose:(e,t)=>{},initialRemember:!1,tryRoutedPath:!0})?.container)}},Symbol.toStringTag,{value:"Module"})),l=e=>{if(null==e)return"";if("string"==typeof e)return e;try{return JSON.stringify(e,null,2)}catch{return String(e)}},d=async e=>{const t=l(e).trim();return t?new Promise(e=>{requestAnimationFrame(()=>{"undefined"!=typeof document&&document.hasFocus&&!document.hasFocus()&&window.focus(),(async()=>{try{if("undefined"!=typeof navigator&&navigator.clipboard?.writeText)return await navigator.clipboard.writeText(t),e({ok:!0,data:t,method:"clipboard-api"})}catch(o){console.warn("[Clipboard] Direct write failed:",o)}try{if("undefined"!=typeof navigator&&navigator.permissions){const o=await navigator.permissions.query({name:"clipboard-write"});if("granted"===o.state||"prompt"===o.state)return await navigator.clipboard.writeText(t),e({ok:!0,data:t,method:"clipboard-api"})}}catch(o){console.warn("[Clipboard] Permission check failed:",o)}try{if("undefined"!=typeof document){const o=document.createElement("textarea");o.value=t,o.style.cssText="position:fixed;left:-9999px;top:-9999px;opacity:0;pointer-events:none;",document.body.appendChild(o),o.select();const n=document.execCommand("copy");if(o.remove(),n)return e({ok:!0,data:t,method:"legacy"})}}catch(o){console.warn("[Clipboard] Legacy execCommand failed:",o)}e({ok:!1,error:"All clipboard methods failed"})})()})}):{ok:!1,error:"Empty content"}},p=async(e,t)=>{const o=e.trim(),n=(t??o).trim();return o?new Promise(e=>{requestAnimationFrame(()=>{"undefined"!=typeof document&&document.hasFocus&&!document.hasFocus()&&window.focus(),(async()=>{try{if("undefined"!=typeof navigator&&navigator.clipboard?.write){const t=new Blob([o],{type:"text/html"}),a=new Blob([n],{type:"text/plain"});return await navigator.clipboard.write([new ClipboardItem({"text/html":t,"text/plain":a})]),e({ok:!0,data:o,method:"clipboard-api"})}}catch(a){console.warn("[Clipboard] HTML write failed:",a)}const t=await d(n);e(t)})()})}):{ok:!1,error:"Empty content"}},u=async e=>new Promise(t=>{requestAnimationFrame(async()=>{"undefined"!=typeof document&&document.hasFocus&&!document.hasFocus()&&window.focus();try{let o;if("string"==typeof e)if(e.startsWith("data:")){const t=await fetch(e);o=await t.blob()}else{const t=await fetch(e);o=await t.blob()}else o=e;if("undefined"!=typeof navigator&&navigator.clipboard?.write){const e="image/png"===o.type?o:await g(o);return await navigator.clipboard.write([new ClipboardItem({[e.type]:e})]),void t({ok:!0,method:"clipboard-api"})}}catch(o){console.warn("[Clipboard] Image write failed:",o)}t({ok:!1,error:"Image clipboard not supported"})})}),g=async e=>new Promise((t,o)=>{if("undefined"==typeof document)return void o(new Error("No document context"));const n=new Image,a=URL.createObjectURL(e);n.onload=()=>{const e=document.createElement("canvas");e.width=n.naturalWidth,e.height=n.naturalHeight;const s=e.getContext("2d");if(!s)return URL.revokeObjectURL(a),void o(new Error("Canvas context failed"));s.drawImage(n,0,0),e.toBlob(e=>{URL.revokeObjectURL(a),e?t(e):o(new Error("PNG conversion failed"))},"image/png")},n.onerror=()=>{URL.revokeObjectURL(a),o(new Error("Image load failed"))},n.src=a}),h=async()=>new Promise(e=>{requestAnimationFrame(()=>{(async()=>{try{if("undefined"!=typeof navigator&&navigator.clipboard?.readText){const t=await navigator.clipboard.readText();return void e({ok:!0,data:t,method:"clipboard-api"})}}catch(t){console.warn("[Clipboard] Read failed:",t)}e({ok:!1,error:"Clipboard read not available"})})()})}),m=async(e,t={})=>{const{type:o,showFeedback:n=!1,silentOnError:a=!1}=t;return new Promise(t=>{requestAnimationFrame(async()=>{let s;if(e instanceof Blob)if(e.type.startsWith("image/"))s=await u(e);else{const t=await e.text();s=await d(t)}else s="html"===o||"string"==typeof e&&e.trim().startsWith("<")?await p(String(e)):"image"===o?await u(e):await d(l(e));!n||!s.ok&&a||f(s),t(s)})})},f=e=>{try{const t=new BroadcastChannel("rs-toast");t.postMessage({type:"show-toast",options:{message:e.ok?"Copied to clipboard":e.error||"Copy failed",kind:e.ok?"success":"error",duration:2e3}}),t.close()}catch(t){console.warn("[Clipboard] Feedback broadcast failed:",t)}},w=()=>{if("undefined"==typeof BroadcastChannel)return()=>{};const e=new BroadcastChannel("rs-clipboard"),t=async e=>{if("copy"===e.data?.type){const t=e.data.options||{};await m(e.data.data,{...t,showFeedback:!1!==t.showFeedback,silentOnError:!0===t.silentOnError})}};return e.addEventListener("message",t),()=>{e.removeEventListener("message",t),e.close()}},y=()=>w(),v=/*#__PURE__*/Object.freeze(/*#__PURE__*/Object.defineProperty({__proto__:null,copy:m,initClipboardReceiver:y,listenForClipboardRequests:w,readText:h,toText:l,writeHTML:p,writeImage:u,writeText:d},Symbol.toStringTag,{value:"Module"})),b={containerId:"rs-toast-layer",position:"bottom",maxToasts:5,zIndex:2147483647},k=/* @__PURE__ */new WeakSet,x=/* @__PURE__ */new Map,S=e=>{const t="string"==typeof e?{message:e}:e,{message:o,kind:n="info",duration:a=3e3,persistent:s=!1,position:r="bottom",onClick:i}=t;if("undefined"==typeof document)return C(t),null;const c={...b,position:r},l=((e,t=document)=>{const o=`${e.containerId}-${e.position}`;if(x.has(o)){const e=x.get(o);if(e.isConnected)return e;x.delete(o)}((e=document)=>{if(k.has(e))return;const t=e.createElement("style");t.id="__rs-toast-styles__",t.textContent='\n.rs-toast-layer {\n    position: fixed;\n    z-index: var(--rs-toast-z, 2147483647);\n    pointer-events: none;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    padding: 1rem;\n    gap: 0.5rem;\n    max-block-size: 80dvb;\n    overflow: hidden;\n    box-sizing: border-box;\n}\n\n.rs-toast-layer[data-position="bottom"],\n.rs-toast-layer:not([data-position]) {\n    inset-block-end: 10dvb;\n    inset-inline: 0;\n    justify-content: flex-end;\n}\n\n.rs-toast-layer[data-position="top"] {\n    inset-block-start: 10dvb;\n    inset-inline: 0;\n    justify-content: flex-start;\n}\n\n.rs-toast-layer[data-position="top-left"] {\n    inset-block-start: 10dvb;\n    inset-inline-start: 0;\n    align-items: flex-start;\n}\n\n.rs-toast-layer[data-position="top-right"] {\n    inset-block-start: 10dvb;\n    inset-inline-end: 0;\n    align-items: flex-end;\n}\n\n.rs-toast-layer[data-position="bottom-left"] {\n    inset-block-end: 10dvb;\n    inset-inline-start: 0;\n    align-items: flex-start;\n}\n\n.rs-toast-layer[data-position="bottom-right"] {\n    inset-block-end: 10dvb;\n    inset-inline-end: 0;\n    align-items: flex-end;\n}\n\n.rs-toast {\n    --toast-bg: oklch(from var(--surface-color, #1a1a1a) l c h / 0.85);\n    --toast-text: var(--on-surface-color, #ffffff);\n    --toast-radius: 9999px;\n    --toast-shadow: 0 2px 8px rgba(0,0,0,0.25);\n\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.5rem;\n    padding: 0.5rem 1rem;\n    max-inline-size: min(90vw, 32rem);\n    inline-size: fit-content;\n\n    border-radius: var(--toast-radius);\n    background: var(--toast-bg);\n    box-shadow: var(--toast-shadow);\n    backdrop-filter: blur(12px) saturate(140%);\n    color: var(--toast-text);\n\n    font-family: system-ui, -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n    font-size: 0.875rem;\n    font-weight: 500;\n    letter-spacing: 0.01em;\n    line-height: 1.4;\n    white-space: nowrap;\n\n    pointer-events: auto;\n    user-select: none;\n    cursor: default;\n\n    opacity: 0;\n    transform: translateY(100%) scale(0.9);\n    transition:\n        opacity 160ms ease-out,\n        transform 160ms cubic-bezier(0.16, 1, 0.3, 1),\n        background-color 100ms ease;\n}\n\n.rs-toast[data-visible] {\n    opacity: 1;\n    transform: translateY(0) scale(1);\n}\n\n.rs-toast:active {\n    transform: scale(0.98);\n}\n\n.rs-toast[data-kind="success"] {\n    --toast-bg: oklch(from var(--color-success, #22c55e) l c h / 0.9);\n}\n\n.rs-toast[data-kind="warning"] {\n    --toast-bg: oklch(from var(--color-warning, #f59e0b) l c h / 0.9);\n}\n\n.rs-toast[data-kind="error"] {\n    --toast-bg: oklch(from var(--color-error, #ef4444) l c h / 0.9);\n}\n\n@media (prefers-reduced-motion: reduce) {\n    .rs-toast,\n    .rs-toast[data-visible] {\n        transition-duration: 0ms;\n        transform: none;\n    }\n}\n',(e.head||e.documentElement).appendChild(t),k.add(e)})(t);let n=t.getElementById(e.containerId);return n||(n=t.createElement("div"),n.id=e.containerId,n.className="rs-toast-layer",t.body.appendChild(n)),n.setAttribute("data-position",e.position),n.style.setProperty("--rs-toast-z",String(e.zIndex)),x.set(o,n),n})(c);for(;l.children.length>=c.maxToasts;)l.firstChild?.remove();const d=document.createElement("div");d.className="rs-toast",d.setAttribute("data-kind",n),d.setAttribute("role","alert"),d.setAttribute("aria-live","error"===n?"assertive":"polite"),d.textContent=o,l.appendChild(d),requestAnimationFrame(()=>{d.setAttribute("data-visible","")});const p=()=>{d.removeAttribute("data-visible"),setTimeout(()=>{d.remove()},200)};return s||setTimeout(p,a),d.addEventListener("click",()=>{i?.(),p()}),d},C=e=>{try{const t=new BroadcastChannel("rs-toast");t.postMessage({type:"show-toast",options:e}),t.close()}catch(t){console.warn("[Toast] Broadcast failed:",t)}},A=()=>{if("undefined"==typeof BroadcastChannel)return()=>{};const e=new BroadcastChannel("rs-toast"),t=e=>{"show-toast"===e.data?.type&&e.data?.options&&S(e.data.options)};return e.addEventListener("message",t),()=>{e.removeEventListener("message",t),e.close()}},I=()=>A(),P=/*#__PURE__*/Object.freeze(/*#__PURE__*/Object.defineProperty({__proto__:null,initToastReceiver:I,listenForToasts:A,showToast:S},Symbol.toStringTag,{value:"Module"}));let L=!1,T=[];const E=e=>{if("string"==typeof e){const t=(e=>{if("string"!=typeof e)return null;try{return JSON.parse(e)}catch{return null}})(e);if(t&&"object"==typeof t){const o=t;if(null!=o.recognized_data){const e=o.recognized_data;return Array.isArray(e)?e.map(e=>"string"==typeof e?e:JSON.stringify(e)).join("\n"):"string"==typeof e?e:JSON.stringify(e)}return"string"==typeof o.verbose_data&&o.verbose_data.trim()?o.verbose_data:e}return e}if(e&&"object"==typeof e){const t=e;if(null!=t.recognized_data){const e=t.recognized_data;return Array.isArray(e)?e.map(e=>"string"==typeof e?e:JSON.stringify(e)).join("\n"):"string"==typeof e?e:JSON.stringify(e)}if("string"==typeof t.verbose_data&&t.verbose_data.trim())return t.verbose_data}return e},W=()=>{T.forEach(e=>e?.()),T=[],L=!1};let U=null,F=null,R=null;const z=e=>{const t=e.text?.trim();if(t)return{content:t,type:"text"};const o=(e.url||e.sharedUrl)?.trim();if(o)return{content:o,type:"url"};const n=e.title?.trim();if(n)return{content:n,type:"text"};if(Array.isArray(e.files)&&e.files.length>0){const t=e.files[0];if(t instanceof File||t instanceof Blob)return{content:null,type:"file"}}return{content:null,type:null}},B=async(e,t=!1)=>{if(console.log("[ShareTarget] Processing shared data:",{hasText:!!e.text,hasUrl:!!e.url,fileCount:e.files?.length||e.fileCount||0,imageCount:e.imageCount||0,source:e.source||"unknown",aiProcessed:e.aiProcessed}),e.aiProcessed&&e.results?.length)return console.log("[ShareTarget] AI already processed in SW, showing result"),S({message:"Content processed by service worker",kind:"success"}),!0;const{content:o,type:n}=z(e);if(console.log("[ShareTarget] Extracted content:",{content:o?.substring(0,50),type:n}),!o&&"file"!==n)return t?(console.log("[ShareTarget] No content to process (skipping)"),!1):e.fileCount&&e.fileCount>0?(console.log("[ShareTarget] Files processed in service worker"),S({message:"Files received and being processed",kind:"info"}),!0):(console.warn("[ShareTarget] No content to process"),S({message:"No content received to process",kind:"warning"}),!1);try{console.log("[ShareTarget] Starting AI processing for type:",n),S({message:"Processing shared content...",kind:"info"});const{recognizeByInstructions:t}=await import("./RecognizeData.js").then(e=>e.R),{getUsableData:a}=await import("./GPT-Responses.js").then(e=>e.G);let s;if("file"===n&&e.files?.[0])s=e.files[0],console.log("[ShareTarget] Processing file:",{name:s.name,type:s.type,size:s.size});else{if(!o)throw new Error("No processable content found");s=o,console.log("[ShareTarget] Processing text content, length:",o.length)}console.log("[ShareTarget] Converting to usable data format");const r=[{type:"message",role:"user",content:[await a({dataSource:s})]}];console.log("[ShareTarget] Calling AI recognition");const i=await t(r,"",void 0,void 0,{useActiveInstruction:!0});if(console.log("[ShareTarget] AI recognition completed:",{ok:i?.ok,hasData:!!i?.data,dataLength:i?.data?.length}),i?.ok&&i?.data){console.log("[ShareTarget] Broadcasting successful AI result to clipboard handlers");const e=new BroadcastChannel("rs-share-target");return e.postMessage({type:"ai-result",data:{success:!0,data:i.data}}),e.close(),!0}{const e=i?.error||"AI processing returned no data";console.warn("[ShareTarget] AI processing failed:",e);const t=new BroadcastChannel("rs-share-target");return t.postMessage({type:"ai-result",data:{success:!1,error:e}}),t.close(),S({message:`Processing failed: ${e}`,kind:"warning"}),!1}}catch(a){if(console.error("[ShareTarget] Processing error:",a),console.log("[ShareTarget] Attempting server-side fallback"),await j(e))return console.log("[ShareTarget] Server-side fallback succeeded"),!0;console.warn("[ShareTarget] All processing methods failed");const t=new BroadcastChannel("rs-share-target");return t.postMessage({type:"ai-result",data:{success:!1,error:a?.message||String(a)}}),t.close(),S({message:`Processing failed: ${a?.message||"Unknown error"}`,kind:"error"}),!1}},j=async e=>{try{const{content:t,type:o}=z(e);if(!t)return!1;console.log("[ShareTarget] Attempting server-side AI fallback");const{getRuntimeSettings:n}=await import("./RuntimeSettings.js").then(e=>e.R),a=await n().catch(()=>null),s=a?.ai?.apiKey;if(!s)return console.log("[ShareTarget] No API key for server fallback"),!1;const r=await fetch("/api/share/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:"text"===o?t:void 0,url:"url"===o?t:void 0,title:e.title,apiKey:s,baseUrl:a?.ai?.baseUrl,model:a?.ai?.customModel||a?.ai?.model})});if(!r.ok)return console.warn("[ShareTarget] Server fallback failed:",r.status),!1;const i=await r.json();if(i?.ok&&i?.data){console.log("[ShareTarget] Broadcasting server-side result to clipboard handlers");const e=new BroadcastChannel("rs-share-target");return e.postMessage({type:"ai-result",data:{success:!0,data:String(i.data)}}),e.close(),!0}return!1}catch(t){return console.warn("[ShareTarget] Server fallback error:",t),!1}},N=()=>{try{return"chrome-extension:"===window.location.protocol||Boolean(chrome?.runtime?.id)}catch{return!1}},M=(e,t="Loading...")=>{e.innerHTML=`\n        <div class="app-loading" style="\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            inline-size: 100%;\n            block-size: 100%;\n            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            font-size: 1.1rem;\n            color: #666;\n            background: #fff;\n            position: absolute;\n            inset: 0;\n            z-index: 10000;\n        ">\n            <div class="loading-spinner" style="\n                inline-size: 32px;\n                block-size: 32px;\n                border: 3px solid #f3f3f3;\n                border-top: 3px solid #007acc;\n                border-radius: 50%;\n                animation: spin 1s linear infinite;\n                margin-bottom: 1rem;\n            "></div>\n            <div class="loading-text">${t}</div>\n            <style>\n                @keyframes spin {\n                    0% { transform: rotate(0deg); }\n                    100% { transform: rotate(360deg); }\n                }\n            </style>\n        </div>\n    `},O=e=>{const t=e.querySelector(".app-loading");t&&(t.style.transition="opacity 0.3s ease-out",t.style.opacity="0",setTimeout(()=>{t.parentNode&&t.remove()},300))},$=(e,t,o)=>{const n=t?.message||t?.toString()||"Unknown error occurred";e.innerHTML=`\n        <div class="app-error" style="\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            inline-size: 100%;\n            block-size: 100%;\n            padding: 2rem;\n            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            text-align: center;\n            background: #fff;\n            color: #333;\n        ">\n            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>\n            <h2 style="margin: 0 0 1rem 0; color: #d32f2f;">Application Error</h2>\n            <p style="margin: 0 0 1.5rem 0; color: #666; max-inline-size: 500px;">${n}</p>\n            ${o?`\n                <button onclick="(${o.toString()})()" style="\n                    padding: 0.75rem 1.5rem;\n                    background: #007acc;\n                    color: white;\n                    border: none;\n                    border-radius: 6px;\n                    font-size: 1rem;\n                    cursor: pointer;\n                    margin-bottom: 1rem;\n                    transition: background-color 0.2s;\n                " onmouseover="this.style.background='#005999'" onmouseout="this.style.background='#007acc'">\n                    Try Again\n                </button>\n            `:""}\n            <button onclick="location.reload()" style="\n                padding: 0.5rem 1rem;\n                background: #666;\n                color: white;\n                border: none;\n                border-radius: 4px;\n                font-size: 0.9rem;\n                cursor: pointer;\n            ">\n                Reload Page\n            </button>\n        </div>\n    `};async function _(e){console.log("[Index] Starting CrossWord frontend loader"),M(e,"Initializing CrossWord...");try{const s=(async()=>{console.log("[PWA] Initializing PWA features...");try{(window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator?.standalone)&&console.log("[PWA] Running in standalone mode"),t.getInstance().startPeriodicChecks();const e=new n,a=await e.register();window.addEventListener("assets-updated",e=>{const{updatedAssets:t}=e.detail;console.log("[PWA] Assets updated:",t);const n=["choice.js","sw.js"];t.some(e=>n.some(t=>e.includes(t)))&&(console.log("[PWA] Critical assets updated, reloading..."),o())});let s=null;return window.addEventListener("beforeinstallprompt",e=>{console.log("[PWA] Install prompt available"),e.preventDefault(),s=e,window.dispatchEvent(new CustomEvent("pwa-install-available",{detail:{prompt:s}}))}),window.addEventListener("appinstalled",()=>{console.log("[PWA] App installed successfully"),s=null}),a}catch(e){console.warn("[PWA] PWA initialization failed:",e)}return null})();N()||(console.log("[Index] Loading CSS..."),M(e,"Loading styles..."),await(()=>{if("undefined"==typeof window)return;if("chrome-extension:"===window.location.protocol)return;const e="rs-crossword-css";if(document.getElementById(e))return;const t=document.createElement("link");t.id=e,t.rel="stylesheet";try{const e=new URL("../assets/crossword.css",import.meta.url);t.href=e.toString()}catch{t.href="assets/crossword.css"}let o=0;t.onerror=()=>{const e=[new URL("./assets/crossword.css",import.meta.url).toString(),"/assets/crossword.css","/apps/cw/assets/crossword.css"];if(o<e.length){const n=e[o++];if(t.href!==n)return console.warn(`[CSS] Trying path: ${n}`),void(t.href=n)}t.onerror=null},document.head.append(t)})(),console.log("[Index] CSS loaded")),O(e),M(e,"Loading application..."),console.log("[Index] Initializing broadcast receivers..."),R||(R=(()=>{if(L)return()=>W();if(L=!0,console.log("[PWA-Copy] Initializing clipboard and toast receivers..."),(async()=>{try{console.log("[PWA-Copy] Checking for pending clipboard operations...");const t=await fetch("/clipboard/pending"),o=await t.json();if(o.operations&&Array.isArray(o.operations)&&o.operations.length>0){console.log("[PWA-Copy] Found",o.operations.length,"pending clipboard operations");for(const t of o.operations)if("ai-result"===t.type&&t.data){console.log("[PWA-Copy] Processing pending AI result:",t.id);const o="string"==typeof t.data?t.data:JSON.stringify(t.data),{copy:n}=await Promise.resolve().then(()=>v);await n(o,{showFeedback:!0});try{await fetch(`/clipboard/remove/${t.id}`,{method:"DELETE"})}catch(e){console.warn("[PWA-Copy] Failed to remove processed operation:",e)}}}}catch(e){console.warn("[PWA-Copy] Failed to check pending operations:",e)}})().catch(console.warn),T.push(y()),T.push(I()),"undefined"!=typeof BroadcastChannel){const e=new BroadcastChannel("rs-clipboard"),t=async e=>{const{type:t,data:o,options:n,operations:a}=e.data||{};if(console.log("[PWA-Copy] Clipboard channel message:",t,o),"copy"===t&&void 0!==o){const{copy:e}=await Promise.resolve().then(()=>v);await e(o,{showFeedback:!0,...n})}if("pending-operations"===t&&a&&Array.isArray(a)){console.log("[PWA-Copy] Received",a.length,"pending operations via broadcast");for(const e of a)if("ai-result"===e.type&&e.data){console.log("[PWA-Copy] Processing broadcasted AI result:",e.id);const t="string"==typeof e.data?e.data:JSON.stringify(e.data),{copy:o}=await Promise.resolve().then(()=>v);await o(t,{showFeedback:!0});try{await fetch(`/clipboard/remove/${e.id}`,{method:"DELETE"})}catch(s){console.warn("[PWA-Copy] Failed to remove processed operation:",s)}}}};e.addEventListener("message",t),T.push(()=>{e.removeEventListener("message",t),e.close()});const o=new BroadcastChannel("rs-share-target"),n=async e=>{const{type:t,data:o}=e.data||{};if(console.log("[PWA-Copy] Share channel message:",t,o),"copy-shared"===t&&o){const{copy:e}=await Promise.resolve().then(()=>v);await e(o,{showFeedback:!0})}if("share-received"===t&&o&&console.log("[PWA-Copy] Share received from SW:",o),"ai-result"===t&&o)if(console.log("[PWA-Copy] AI result from SW:",o),o.success&&o.data){const e="string"==typeof o.data?o.data:JSON.stringify(o.data),{copy:t}=await Promise.resolve().then(()=>v);await t(e,{showFeedback:!0})}else{const{showToast:e}=await Promise.resolve().then(()=>P);e({message:o.error||"Processing failed",kind:"error"})}};o.addEventListener("message",n),T.push(()=>{o.removeEventListener("message",n),o.close()});const a=new BroadcastChannel("rs-sw"),s=async e=>{const{type:t,results:o}=e.data||{};if(console.log("[PWA-Copy] SW channel message:",t,o),"commit-to-clipboard"===t&&o&&Array.isArray(o))for(const n of o)if("queued"===n?.status&&n?.data){console.log("[PWA-Copy] Copying result data:",n.data);const e=E(n.data),{copy:t}=await Promise.resolve().then(()=>v);await t(e,{showFeedback:!0});break}};a.addEventListener("message",s),T.push(()=>{a.removeEventListener("message",s),a.close()})}return console.log("[PWA-Copy] Receivers initialized"),()=>W()})()),console.log("[Index] Broadcast receivers ready"),console.log("[Index] Setting up share target handling..."),(()=>{const e=new URLSearchParams(window.location.search),t=e.get("shared");if("1"===t||"true"===t){console.log("[ShareTarget] Detected shared=1 URL param, processing server-side share");const t={title:e.get("title")||void 0,text:e.get("text")||void 0,url:e.get("url")||void 0,sharedUrl:e.get("sharedUrl")||void 0,timestamp:Date.now(),source:"url-params"};console.log("[ShareTarget] Share data from URL params:",{title:t.title,text:t.text,url:t.url,sharedUrl:t.sharedUrl});const o=new URL(window.location.href);["shared","action","title","text","url","sharedUrl"].forEach(e=>o.searchParams.delete(e)),window.history.replaceState({},"",o.pathname+o.hash);const{content:n,type:a}=z(t);if(console.log("[ShareTarget] Extracted from URL params:",{content:n?.substring(0,50),type:a}),n||"file"===a)return console.log("[ShareTarget] Processing from URL params"),void B(t,!0);console.log("[ShareTarget] No processable content in URL params, checking cache"),"caches"in window&&caches.open("share-target-data").then(e=>e.match("/share-target-data")).then(e=>e?.json?.()).then(async e=>{e?(console.log("[ShareTarget] Retrieved cached data:",e),await B(e,!0)):console.log("[ShareTarget] No cached share data found")}).catch(e=>console.warn("[ShareTarget] Cache retrieval failed:",e))}else if("test"===t){S({message:"Share target route working",kind:"info"});const e=new URL(window.location.href);e.searchParams.delete("shared"),window.history.replaceState({},"",e.pathname+e.hash)}try{const e=sessionStorage.getItem("rs-pending-share");if(e){sessionStorage.removeItem("rs-pending-share");const t=JSON.parse(e);console.log("[ShareTarget] Found pending share in sessionStorage:",t),B(t,!0)}}catch(o){}"undefined"!=typeof BroadcastChannel?(new BroadcastChannel("rs-share-target").addEventListener("message",async e=>{const t=e.data?.type,o=e.data?.data;console.log("[ShareTarget] Broadcast received:",{type:t,hasData:!!o}),"share-received"===t&&o?(console.log("[ShareTarget] Share notification received:",{hasText:!!o.text,hasUrl:!!o.url,fileCount:o.fileCount||0,aiEnabled:o.aiEnabled,source:o.source}),o.fileCount>0&&!o.files?.length?S({message:`Processing ${o.fileCount} file(s)...`,kind:"info"}):(o.text||o.url||o.title)&&(console.log("[ShareTarget] Processing broadcasted share data"),await B(o,!0))):"ai-result"===t&&console.log("[ShareTarget] AI result broadcast received (handled by PWA clipboard)")}),console.log("[ShareTarget] Broadcast channel listener set up")):console.warn("[ShareTarget] BroadcastChannel not available")})(),console.log("[Index] Share target handling ready"),console.log("[Index] Initializing service worker..."),await(async()=>F||(F=(async()=>{if("undefined"==typeof window)return null;if("chrome-extension:"===window.location.protocol)return null;if(!("serviceWorker"in navigator))return console.warn("[PWA] Service workers not supported"),null;try{const e=new URL("./apps/cw/sw.js",window.location.origin).href;console.log("[PWA] Registering service worker:",e);const t=await(navigator.serviceWorker.register(e,{scope:"/",type:"module",updateViaCache:"none"})?.catch?.(e=>(console.error("[PWA] Service worker registration failed:",e),null)));return U=t,t?.addEventListener?.("updatefound",()=>{const e=t?.installing;e&&e?.addEventListener?.("statechange",()=>{"installed"===e?.state&&navigator.serviceWorker.controller&&(console.log("[PWA] New service worker available"),S({message:"App update available",kind:"info"}))})}),setInterval(()=>{t?.update?.().catch?.(console.warn)},18e5),console.log("[PWA] Service worker registered successfully"),t}catch(e){return console.error("[PWA] Service worker registration failed:",e),null}})(),F))(),console.log("[Index] Service worker ready"),console.log("[Index] Setting up launch queue consumer..."),await(async()=>{if("launchQueue"in window)try{window.launchQueue.setConsumer(async e=>{if(console.log("[LaunchQueue] Launch params received:",e),e.files&&e.files.length>0){console.log(`[LaunchQueue] Processing ${e.files.length} file(s)`);const o=[];let n=!1;for(const a of e.files)try{if(a.getFile){const e=await a.getFile();o.push(e),("text/markdown"===e.type||e.name.toLowerCase().endsWith(".md"))&&(n=!0)}else a instanceof File&&(o.push(a),("text/markdown"===a.type||a.name.toLowerCase().endsWith(".md"))&&(n=!0))}catch(t){console.warn("[LaunchQueue] Failed to get file from handle:",t)}if(o.length>0){const e={files:o,fileCount:o.length,timestamp:Date.now(),imageCount:o?.filter?.(e=>e.type.startsWith("image/")).length,markdownCount:o?.filter?.(e=>"text/markdown"===e.type||e.name.toLowerCase().endsWith(".md")).length,source:"launch-queue"};if(console.log("[LaunchQueue] Created share data:",{fileCount:e.fileCount,imageCount:e.imageCount,fileTypes:o?.map?.(e=>({name:e.name,type:e.type,size:e.size})),source:e.source}),n&&1===o.length){const e=o[0];try{const t=await e.text();console.log("[LaunchQueue] Opening markdown file directly:",e.name);const o=new URL(window.location.href);return o.searchParams.set("markdown-content",t),o.searchParams.set("markdown-filename",e.name),o.hash="",void(window.location.href=o.toString())}catch(t){return console.warn("[LaunchQueue] Failed to read markdown file:",t),void S({message:`Failed to open markdown file: ${e.name}`,kind:"error"})}}S({message:`Processing ${o.length} launched file(s)...`,kind:"info"});try{await B(e,!1)?console.log("[LaunchQueue] Share target processing completed successfully"):(console.warn("[LaunchQueue] Share target processing returned false"),S({message:`Received ${o.length} file(s) but processing failed`,kind:"warning"}))}catch(t){console.error("[LaunchQueue] Failed to process files:",t),S({message:`Failed to process ${o.length} launched file(s)`,kind:"error"})}}}e.targetURL&&console.log("[LaunchQueue] Target URL:",e.targetURL)}),console.log("[LaunchQueue] Consumer set up successfully")}catch(e){console.error("[LaunchQueue] Failed to set up consumer:",e)}else console.log("[LaunchQueue] launchQueue API not available")})(),console.log("[Index] Launch queue consumer ready"),console.log("[Index] Checking for pending share data...");try{await(async()=>{try{const e=sessionStorage.getItem("rs-pending-share");if(!e)return null;sessionStorage.removeItem("rs-pending-share");const t=JSON.parse(e);if(console.log("[ShareTarget] Found pending share data:",t),"caches"in window){const e=await caches.open("share-target-data");await e.put("/share-target-data",new Response(JSON.stringify({...t,files:[],timestamp:t.timestamp||Date.now()}),{headers:{"Content-Type":"application/json"}}))}return t}catch(e){return console.warn("[ShareTarget] Failed to process pending share data:",e),null}})()}catch(a){console.warn("[Index] Pending share data check failed:",a)}console.log("[Index] Pending share data check complete"),await s,console.log("[Index] PWA initialization complete"),window.addEventListener("route-changed",async t=>{const{path:o,source:n}=t.detail;if(console.log("[Index] Route change from",n,"to path:",o),"boot-menu"===n)if("basic"===o){O(e),M(e,"Loading Basic Edition...");try{const t=await r("basic");O(e),await t.mount(e),console.log("[Index] Basic app loaded from route change")}catch(a){console.error("[Index] Failed to load basic app from route:",a),$(e,a,()=>_(e))}}else if("faint"===o){O(e),M(e,"Loading Experimental Edition...");try{const t=await r("faint");O(e),await t.mount(e),console.log("[Index] Faint app loaded from route change")}catch(a){console.error("[Index] Failed to load faint app from route:",a),$(e,a,()=>_(e))}}});const c="basic",l=(location.pathname||"").replace(/^\//,"").trim().toLowerCase(),d=new URLSearchParams(window.location.search).get("markdown-content");if(console.log("[Index] Processing route:",l),!l||"/"==l){O(e);const t=await r("");return await t.mount(e),void console.log("[Index] Boot menu loaded")}if("basic"===l){console.log("[Index] Direct route: loading basic app"),O(e);const t=await r("basic");return await t.mount(e),void console.log("[Index] Basic app loaded")}if("faint"===l){console.log("[Index] Direct route: loading faint app"),O(e);const t=await r("faint");return await t.mount(e),void console.log("[Index] Faint app loaded")}if("print"===l){console.log("[Index] Direct route: loading print view"),O(e);const t=await r("print");return await t.mount(e),void console.log("[Index] Print app loaded for print")}console.log("[Index] Root path - checking user preferences");const p=N(),u=!N(),g=(()=>{try{return"1"===localStorage.getItem("rs-frontend-choice-remember")}catch{return!1}})(),h=(()=>{try{const e=localStorage.getItem("rs-frontend-choice");return"basic"===e||"faint"===e?e:null}catch{return null}})();if(console.log("[Index] Context: extension=%s, pwa=%s, remembered=%s, stored=%s",p,u,g,h),d){console.log("[Index] Markdown content detected - loading basic app"),O(e);const t=await r("basic");return await t.mount(e),void console.log("[Index] Basic app loaded for markdown")}if(!p&&u&&g&&h){console.log("[Index] Using remembered choice:",h),O(e);const t=await r(h);return await t.mount(e),void console.log("[Index] Remembered app loaded")}if(p||!u){console.log("[Index] Loading default app (extension or non-PWA)"),O(e);const t=await r(c);return await t.mount(e),void console.log("[Index] Default app loaded")}console.log("[Index] No remembered choice - showing choice screen"),O(e),e.replaceChildren();let m=!1,f=10;const{container:w,countdownEl:b}=i({seconds:f,defaultChoice:c,initialRemember:g,tryRoutedPath:!0,onChoose:async(t,o)=>{if(!m){console.log("[Index] User chose:",t,"remember:",o),m=!0,clearInterval(k),((e,t)=>{try{localStorage.setItem("rs-frontend-choice",e),localStorage.setItem("rs-frontend-choice-remember",t?"1":"0")}catch{}})(t,!!o),e.replaceChildren(),M(e,`Loading ${"basic"===t?"Basic Edition":"Experimental Edition"}...`);try{const o=await r(t);O(e),await o.mount(e),console.log("[Index] Chosen app loaded")}catch(a){console.error("[Index] Failed to load chosen app:",a),$(e,a,()=>_(e))}}}}),k=window.setInterval(()=>{if(m)return;f-=1;const t=b.querySelector("b");t&&(t.textContent=String(Math.max(0,f))),f<=0&&(console.log("[Index] Auto-starting default app"),m=!0,clearInterval(k),(async()=>{e.replaceChildren(),M(e,"Loading Basic Edition...");try{const t=await r(c);O(e),await t.mount(e),console.log("[Index] Default app auto-loaded")}catch(a){console.error("[Index] Failed to auto-load default app:",a),$(e,a,()=>_(e))}})())},1e3);e.append(w),console.log("[Index] Choice screen displayed")}catch(a){console.error("[Index] Frontend loader failed:",a),$(e,a,()=>_(e))}}export{v as C,a as c,s as f,_ as i,h as r,d as w};