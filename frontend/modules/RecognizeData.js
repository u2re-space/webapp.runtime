import{l as e,b as n}from"./RuntimeSettings.js";import{c as t,g as a}from"./GPT-Responses.js";import"./vendor/jsox.js";const o=(e,n)=>n?.trim()?`${e}\n\n---\n\nUSER CUSTOM INSTRUCTIONS:\n${n.trim()}\n\n---\n\nApply the user's custom instructions above when processing the data. Prioritize user instructions when they conflict with default behavior.\n`:e,r=()=>`ci_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,s=[{label:"Markdown & KaTeX",instruction:"Format all recognized content as clean Markdown with proper KaTeX math notation.\n\nRules for math expressions:\n- Inline math: use SINGLE dollar signs, e.g. $x^2 + y^2 = z^2$\n- Block/display math: use DOUBLE dollar signs on separate lines:\n  $$\\int_0^1 f(x) dx$$\n- Do NOT add extra dollar signs - use exactly one $ for inline, exactly two $$ for block\n- Preserve original mathematical notation accurately\n\nRules for text formatting:\n- Use proper heading levels (# ## ###)\n- Format lists with - or 1. 2. 3.\n- Use **bold** and *italic* appropriately\n- Format code as `inline` or ```block```\n- Format tables as | Markdown | tables |\n\nPrioritize mathematical accuracy and proper Markdown structure.",enabled:!0,order:0},{label:"Solve & Answer",instruction:"Solve problems or answer questions. Auto-detect the type:\n• Math equations → Solve step-by-step with KaTeX\n• Quiz/test questions → Provide correct answer with explanation\n• Homework problems → Solve and explain reasoning\n\nFormat:\n**Problem/Question:** <content, use $KaTeX$ for math>\n**Solution/Answer:** <step-by-step or direct answer>\n**Explanation:** <clear reasoning>\n\nFor multiple choice: identify correct option + explain why.\nFor math: use $ for inline, $$ for block equations.\nShow all work and simplify the final answer.",enabled:!0,order:1},{label:"Solve with Graphics",instruction:'Solve problems and generate visual representations when applicable.\n\nFor functions, graphs, diagrams, geometric shapes, or data visualizations:\nGenerate inline SVG code as a data URI: `![Graph](data:image/svg+xml,<encoded_svg>)`\n\nSVG Generation Rules:\n1. Use encodeURIComponent() encoding for the SVG content\n2. Keep SVG minimal but accurate (viewBox, paths, text labels)\n3. Use appropriate colors: #2563eb (blue) for main, #dc2626 (red) for secondary\n4. Include axis labels, grid lines, and legends where helpful\n5. Size: viewBox="0 0 400 300" for standard graphs\n\nWhen to generate SVG:\n• Function plots: y = f(x), parametric curves, polar plots\n• Geometric diagrams: triangles, circles, angles, constructions\n• Data charts: bar, line, pie charts\n• Flowcharts and simple diagrams\n• Number lines and coordinate systems\n\nFormat:\n**Problem:** <description>\n**Solution:** <step-by-step with $KaTeX$>\n**Visualization:**\n![<title>](data:image/svg+xml,<encodeURIComponent_svg>)\n\nAlways provide both the mathematical solution AND the visual when graphics are suitable.',enabled:!0,order:2},{label:"Write code",instruction:"Generate code based on the recognized request/description.\n\nFormat:\n**Request:** <what the code should do>\n**Language:** <programming language>\n**Code:**\n```<lang>\n<code>\n```\n\nWrite clean, functional code with meaningful names and brief comments.",enabled:!0,order:3},{label:"Extract CSS",instruction:"Generate CSS that matches the visual appearance of the content.\n\nExtract:\n- Colors (oklch, hex, rgb)\n- Typography (font, size, weight)\n- Spacing (padding, margin, gap)\n- Layout (flex, grid)\n- Effects (shadow, radius, gradients)\n\nUse CSS custom properties and modern syntax.\nInclude responsive considerations.",enabled:!0,order:4},{label:"Generate Diagram",instruction:'Generate SVG diagrams, charts, or visual representations from descriptions.\n\nOutput as inline data URI: ![<title>](data:image/svg+xml,<encoded_svg>)\n\nDiagram Types:\n• Flowcharts: processes, algorithms, decision trees\n• Charts: bar, line, pie, scatter plots\n• Diagrams: UML, ER, network, architecture\n• Graphs: mathematical functions, data visualization\n• Geometric: shapes, constructions, proofs\n\nSVG Requirements:\n1. Use encodeURIComponent() for the SVG string\n2. viewBox="0 0 600 400" (adjust as needed)\n3. Clean, minimal SVG with proper structure\n4. Colors: #3b82f6 primary, #10b981 secondary, #f59e0b accent\n5. Include labels, arrows, and legends\n6. Use <text> for readable annotations\n\nExample output format:\n**Diagram:** <description>\n![<title>](data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20400%20300%22%3E...%3C%2Fsvg%3E)',enabled:!0,order:5},{label:"Extract contacts",instruction:"Focus on extracting contact information: phone numbers, emails, addresses, and names. Format phone numbers in E.164 format.",enabled:!0,order:6},{label:"Summarize content",instruction:"Provide a brief summary of the recognized content. Include key points and main takeaways.",enabled:!0,order:7},{label:"Extract URLs and links",instruction:"Focus on extracting all URLs, links, and web addresses. Validate and normalize them.",enabled:!0,order:8},{label:"Code extraction",instruction:"Focus on extracting code snippets. Detect the programming language and format appropriately with syntax highlighting markers.",enabled:!0,order:9},{label:"Table extraction",instruction:"Focus on extracting tabular data. Format as proper Markdown tables with headers.",enabled:!0,order:10}],i=()=>{try{return"undefined"!=typeof chrome&&chrome?.runtime?.id?"crx":"undefined"!=typeof self&&"ServiceWorkerGlobalScope"in self||"undefined"!=typeof navigator&&"standalone"in navigator?"pwa":"core"}catch{return"unknown"}},c=async()=>{const t=i();console.log("[AI] Detected platform:",t);try{if("crx"===t){console.log("[AI] Loading CRX settings...");const n=await e();return console.log("[AI] CRX settings loaded:",!!n,n?.ai?"AI config present":"No AI config"),n}{console.log("[AI] Loading PWA/Core runtime settings...");const e=await n();return console.log("[AI] Runtime settings loaded:",!!e,e?.ai?"AI config present":"No AI config"),e}}catch(a){return console.error(`[AI-Service] Failed to load settings for platform ${t}:`,a),null}},l=async()=>{try{const{getActiveInstructionText:e}=await import("./CustomInstructions.js");return await e()}catch{try{const{getActiveInstructionText:e}=await import("./CustomInstructions.js");return await e()}catch{return""}}},d={auto:"",en:"\n\nIMPORTANT: Respond in English. All explanations, answers, and comments must be in English.",ru:"\n\nВАЖНО: Отвечай на русском языке. Все объяснения, ответы и комментарии должны быть на русском языке."},m=async()=>{try{const e=await c(),n=e?.ai?.responseLanguage||"auto";let t=d[n]||"";return!!e?.ai?.translateResults&&"auto"!==n&&(t+="\n\nAdditionally, translate the recognized content to the response language if it differs from the source."),t}catch{return""}},u=async()=>{try{const e=await c();return e?.ai?.generateSvgGraphics?'\n---\n\nGRAPHICS GENERATION (when applicable):\nWhen the problem involves functions, graphs, geometric shapes, diagrams, or data that can be visualized:\n\nGenerate inline SVG as Markdown image with data URI:\n![<title>](data:image/svg+xml,<encodeURIComponent_encoded_svg>)\n\nSVG Requirements:\n- Use encodeURIComponent() encoding for the entire SVG string\n- viewBox="0 0 400 300" (or appropriate dimensions)\n- Colors: #3b82f6 (blue), #10b981 (green), #f59e0b (orange), #ef4444 (red)\n- Include axis labels, tick marks, and legends\n- Use <text> elements for annotations\n- Keep SVG minimal but informative\n\nApply to:\n• Function graphs: f(x), parametric, polar\n• Geometric constructions and proofs\n• Data visualizations and charts\n• Diagrams and flowcharts\n• Coordinate systems and number lines\n\nAlways include both the mathematical solution AND the visualization.\n':""}catch{return""}},g="gpt-5.2",p="https://api.proxyapi.ru/openai/v1",f='\nRecognize data from image, also preferred to orient by fonts in image.\n\nIn recognition result, do not include image itself.\n\nIn recognized from image data (what you seen in image), do:\n- If textual content, format as Markdown string (multiline).\n- If math (expression, equation, formula):\n  - For inline math, use SINGLE dollar signs: $x^2 + y^2 = z^2$\n  - For block/display math, use DOUBLE dollar signs: $$\\int_0^1 f(x) dx$$\n  - Do NOT add extra dollar signs - use exactly one $ for inline, exactly two $$ for block\n- If table (or looks alike table), format as | table |\n- If image reference, format as [$image$]($image$)\n- If code, format as ```$code$``` (multiline) or `$code$` (single-line)\n- If JSON, format as JSON string.\n- If phone number, format as correct phone number (in normalized format).\n  - If phone numbers (for example starts with +7, format as 8), replace to correct regional code.\n  - Trim spaces from phone numbers, emails, URLs, dates, times, codes, etc.\n  - Remove brackets, parentheses, spaces or other symbols from phone numbers.\n- If email, format as correct email (in normalized format).\n- If URL, format as correct URL (in normalized format), decode unicode to readable.\n- If date, format as correct date (ISO format preferred).\n- If time, format as correct time (24h format preferred).\n- If barcode/QR code, extract the encoded data.\n- If other, format as $text$.\n- If seen alike list, format as list (in markdown format).\n\nAdditional analysis:\n- Detect document type (receipt, business card, screenshot, etc.)\n- Extract structured data when possible (names, addresses, prices)\n- Identify any logos or branding\n- Note image quality issues that may affect recognition\n\nIf nothing found, return: {"ok": false, "error": "No data recognized"}\n\nCRITICAL OUTPUT FORMAT: Return ONLY valid JSON. No markdown code blocks, no explanations, no prose.\nYour response must start with { and end with }.\n\nExpected output structure:\n{\n    "recognized_data": [...],\n    "keywords_and_tags": [...],\n    "verbose_data": "markdown description",\n    "document_type": "...",\n    "structured_extraction": {...},\n    "confidence": 0.0-1.0,\n    "quality_notes": [...]\n}\n',h='\nHere may be HTML, Regular Text, LaTeX, etc input formats.\n\nNeeds to convert or reformat presented data to target format (Markdown string).\n\n- If textual content, format as Markdown string (multiline).\n- If math (expression, equation, formula):\n  - For inline math, use SINGLE dollar signs: $x^2 + y^2 = z^2$\n  - For block/display math, use DOUBLE dollar signs: $$\\int_0^1 f(x) dx$$\n  - Do NOT add extra dollar signs - use exactly one $ for inline, exactly two $$ for block\n- If table (or looks alike table), format as | table |\n- If image, format as [$image$]($image$)\n- If code, format as ```$code$``` (multiline) or `$code$` (single-line)\n- If JSON, format as correct JSON string, and trim spaces from JSON string.\n- If phone number, format as correct phone number (in normalized format).\n  - If phone numbers (for example starts with +7, format as 8), replace to correct regional code.\n  - Trim spaces from phone numbers, emails, URLs, dates, times, codes, etc.\n  - Remove brackets, parentheses, spaces or other symbols from phone numbers.\n- If email, format as correct email (in normalized format).\n- If URL, format as correct URL (in normalized format).\n- If date, format as correct date (ISO format preferred).\n- If time, format as correct time (24h format).\n- If other, format as $text$.\n- If seen alike list, format as list (in markdown format).\n\nAdditional processing:\n- Detect the source format (HTML, LaTeX, plain text, etc.)\n- Preserve semantic structure during conversion\n- Extract metadata if present\n- Normalize encoding issues\n\nCRITICAL OUTPUT FORMAT: Return ONLY valid JSON. No markdown code blocks, no explanations, no prose.\nYour response must start with { and end with }.\n\nExpected output structure:\n{\n    "recognized_data": [...],\n    "keywords_and_tags": [...],\n    "verbose_data": "markdown content",\n    "source_format": "...",\n    "confidence": 0.0-1.0\n}\n',w="\nSolve equations, answer questions, and explain mathematical or logical problems from the provided content.\n\nFor equations and math problems:\n- Show step-by-step solutions\n- Provide final answers clearly marked\n- Explain reasoning for each step\n\nFor general questions:\n- Provide accurate, well-reasoned answers\n- Include relevant context and explanations\n- If multiple interpretations possible, address them\n\nFor quizzes and tests:\n- Show the correct answer with explanation\n- Explain why other options are incorrect\n\nAlways respond in the specified language and format results clearly.\n",b="\nWrite clean, efficient, and well-documented code based on the provided description, requirements, or image.\n\nCode requirements:\n- Use appropriate programming language for the task\n- Follow language-specific best practices and conventions\n- Include proper error handling\n- Add meaningful comments and documentation\n- Make code readable and maintainable\n- Use appropriate data structures and algorithms\n\nIf generating from an image or visual description:\n- Analyze the visual elements and requirements\n- Implement the described functionality\n- Ensure code compiles and runs correctly\n\nAlways respond in the specified language and provide complete, working code.\n",y="\nExtract and generate clean, modern CSS from the provided content, image, or description.\n\nCSS requirements:\n- Use modern CSS features and best practices\n- Generate semantic, maintainable stylesheets\n- Include responsive design considerations\n- Use appropriate selectors and specificity\n- Follow CSS naming conventions (BEM, etc.)\n- Include comments for complex styles\n\nIf extracting from an image:\n- Analyze visual design elements\n- Generate corresponding CSS rules\n- Preserve layout, colors, typography, and spacing\n- Use modern CSS features (Flexbox, Grid, etc.)\n\nAlways respond in the specified language and provide complete, valid CSS.\n",I=async n=>{console.log("[AI] getGPTInstance called with config:",!1);const a=await e();console.log("[AI] Settings loaded:",!!a,a?.ai?"AI settings present":"No AI settings");const o=a?.ai?.apiKey;if(console.log("[AI] API key available:",!!o),!o)return console.error("[AI] No API key found - returning null"),null;const r=a?.ai?.baseUrl||p,s=a?.ai?.model||g;return console.log("[AI] Creating GPT instance with URL:",r,"model:",s),t(o,r,s)},_=async(n,a,r,s,i)=>{const c=(await e())?.ai,d=s?.apiKey||c?.apiKey;if(!d){const e={ok:!1,error:"No API key or input"};return r?.(e),e}if(!n){const e={ok:!1,error:"No input provided"};return r?.(e),e}let m=a;if(console.log("[RecognizeData] Custom instruction from options:",!!i?.customInstruction),console.log("[RecognizeData] useActiveInstruction:",i?.useActiveInstruction),i?.customInstruction)console.log("[RecognizeData] Using provided custom instruction"),m=o(a,i.customInstruction);else if(!1!==i?.useActiveInstruction){console.log("[RecognizeData] Fetching active instruction from settings...");const e=await l();console.log("[RecognizeData] Active instruction:",e?`"${e.substring(0,50)}..."`:"(none)"),e&&(m=o(a,e),console.log("[RecognizeData] Applied active custom instruction"))}else console.log("[RecognizeData] Custom instructions disabled via options");const u=t(d,s?.baseUrl||c?.baseUrl||p,s?.model||c?.model||g);let f,h;u.clearPending(),await u.askToDoAction(m),Array.isArray(n)&&("message"===n?.[0]?.type||n?.[0]?.role)?await(u?.getPending?.()?.push?.(...n)):await(u?.attachToRequest?.(n));try{f=await(u?.sendRequest?.("low","low"))}catch(b){h=String(b)}const w={ok:!!f&&!h,data:f?.trim?.()||void 0,error:h||(f?void 0:"No response from AI")};return r?.(w),w},v=async(e,n,t,a)=>_(e,f,n,t,a),k=async(e,n,t,a)=>_(e,h,n,t,a),x=async(e,n,t,o)=>{const r=await a({dataSource:e}),s=[{type:"message",role:"user",content:[r]}];return"input_image"===r?.[0]?.type||"input_image"===r?.type?v(s,n,t,o):k(s,n,t,o)},A=async(e,n)=>{console.log("[AI] solveAndAnswer called with input:",e?.substring?.(0,100)||e);const t=await I();if(console.log("[AI] GPT instance created:",!!t),!t)return console.error("[AI] Failed to create GPT instance - check API key and settings"),{ok:!1,recognized_data:[],keywords_and_tags:[],verbose_data:"",suggested_type:null,confidence:0,source_kind:"unknown",processing_time_ms:0,errors:["AI service not available"],warnings:[]};const a=Date.now();try{const o=await m(),r=await u(),s=w+o+r;let i="";n?.customInstruction?i=n.customInstruction:n?.useActiveInstruction&&(i=await l()),i&&await t.askToDoAction(i),await t.askToDoAction(s),await t.giveForRequest(e),console.log("[AI] Sending request with effort='high', verbosity='medium'");const c=await t.sendRequest("high","medium"),d=Date.now()-a;return console.log("[AI] Raw response received:",!!c,c?.substring?.(0,200)||"null/empty"),c?(console.log("[AI] solveAndAnswer success"),{ok:!0,recognized_data:[c],keywords_and_tags:["solution","answer"],verbose_data:c,suggested_type:"solution",confidence:.9,source_kind:"text",processing_time_ms:d,errors:[],warnings:[]}):(console.error("[AI] solveAndAnswer failed - no response from sendRequest"),{ok:!1,recognized_data:[],keywords_and_tags:[],verbose_data:"",suggested_type:null,confidence:0,source_kind:"unknown",processing_time_ms:d,errors:["Failed to get response"],warnings:[]})}catch(o){return{ok:!1,recognized_data:[],keywords_and_tags:[],verbose_data:"",suggested_type:null,confidence:0,source_kind:"unknown",processing_time_ms:Date.now()-a,errors:[String(o)],warnings:[]}}},S=async(e,n)=>{const t=await I();if(!t)return{ok:!1,recognized_data:[],keywords_and_tags:[],verbose_data:"",suggested_type:null,confidence:0,source_kind:"unknown",processing_time_ms:0,errors:["AI service not available"],warnings:[]};const a=Date.now();try{const o=await m(),r=await u(),s=b+o+r;let i="";n?.customInstruction?i=n.customInstruction:n?.useActiveInstruction&&(i=await l()),i&&await t.askToDoAction(i),await t.askToDoAction(s),await t.giveForRequest(e);const c=await t.sendRequest("high","medium"),d=Date.now()-a;return c?{ok:!0,recognized_data:[c],keywords_and_tags:["code","programming"],verbose_data:c,suggested_type:"code",confidence:.9,source_kind:"text",processing_time_ms:d,errors:[],warnings:[]}:{ok:!1,recognized_data:[],keywords_and_tags:[],verbose_data:"",suggested_type:null,confidence:0,source_kind:"unknown",processing_time_ms:d,errors:["Failed to generate code"],warnings:[]}}catch(o){return{ok:!1,recognized_data:[],keywords_and_tags:[],verbose_data:"",suggested_type:null,confidence:0,source_kind:"unknown",processing_time_ms:Date.now()-a,errors:[String(o)],warnings:[]}}},R=async(e,n)=>{const t=await I();if(!t)return{ok:!1,recognized_data:[],keywords_and_tags:[],verbose_data:"",suggested_type:null,confidence:0,source_kind:"unknown",processing_time_ms:0,errors:["AI service not available"],warnings:[]};const a=Date.now();try{const o=await m(),r=await u(),s=y+o+r;let i="";n?.customInstruction?i=n.customInstruction:n?.useActiveInstruction&&(i=await l()),i&&await t.askToDoAction(i),await t.askToDoAction(s),await t.giveForRequest(e);const c=await t.sendRequest("high","medium"),d=Date.now()-a;return c?{ok:!0,recognized_data:[c],keywords_and_tags:["css","styles","stylesheet"],verbose_data:c,suggested_type:"css",confidence:.9,source_kind:"text",processing_time_ms:d,errors:[],warnings:[]}:{ok:!1,recognized_data:[],keywords_and_tags:[],verbose_data:"",suggested_type:null,confidence:0,source_kind:"unknown",processing_time_ms:d,errors:["Failed to extract CSS"],warnings:[]}}catch(o){return{ok:!1,recognized_data:[],keywords_and_tags:[],verbose_data:"",suggested_type:null,confidence:0,source_kind:"unknown",processing_time_ms:Date.now()-a,errors:[String(o)],warnings:[]}}},T=/*#__PURE__*/Object.freeze(/*#__PURE__*/Object.defineProperty({__proto__:null,DATA_CONVERSION_INSTRUCTION:h,EXTRACT_CSS_INSTRUCTION:y,IMAGE_INSTRUCTION:f,SOLVE_AND_ANSWER_INSTRUCTION:w,WRITE_CODE_INSTRUCTION:b,analyzeRecognizeUnified:x,convertTextualData:k,detectPlatform:i,extractCSS:R,getActiveCustomInstruction:l,getGPTInstance:I,getLanguageInstruction:m,getSvgGraphicsAddon:u,loadAISettings:c,recognizeByInstructions:_,recognizeImageData:v,solveAndAnswer:A,writeCode:S},Symbol.toStringTag,{value:"Module"}));export{s as D,T as R,x as a,o as b,R as e,r as g,_ as r,A as s,S as w};